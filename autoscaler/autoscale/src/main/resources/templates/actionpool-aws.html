<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NimbusRun • AWS Action Pools</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <style>
    pre code { white-space: pre; }
    .badge-cap { text-transform: capitalize; }
    .cursor-pointer { cursor: pointer; }
    .card-hover:hover { box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important; }
  </style>
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg bg-dark navbar-dark">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="#">NimbusRun Admin</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav" aria-controls="nav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a href="#pools" class="nav-link">Action Pools</a></li>
        <li class="nav-item"><a href="posted-webhooks.html" class="nav-link">Posted Webhooks</a></li>
      </ul>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div class="d-flex align-items-center gap-3 mb-3">
    <h1 class="h3 mb-0">AWS Action Pool Status</h1>
    <span id="computeTypeBadge" class="badge text-bg-secondary">compute: —</span>
    <span id="groupBadge" class="badge text-bg-secondary">group: —</span>
    <div class="ms-auto d-flex gap-2">
      <button id="refreshBtn" class="btn btn-outline-primary btn-sm">Refresh</button>
    </div>
  </div>

  <div id="statusRow" class="row g-3 align-items-center mb-4">
    <div class="col-auto"><span class="text-muted">Last updated:</span></div>
    <div class="col-auto"><span id="lastUpdated" class="badge text-bg-light">—</span></div>
    <div class="col-auto d-none" id="loadingWrap">
      <div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading…</span></div>
    </div>
    <div class="col-12 col-md">
      <div id="alertBox"></div>
    </div>
  </div>

  <!-- Workflow Example / Builder -->
  <section id="workflow" class="mb-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center mb-3">
          <h2 class="h5 mb-0">GitHub Actions Workflow Example</h2>
          <span class="ms-2 badge text-bg-info">self-hosted runners</span>
        </div>

        <div class="row g-3 align-items-end mb-3">
          <div class="col-12 col-md-4">
            <label class="form-label">Runner Group</label>
            <div id="groupValue" class="form-control-plaintext">—</div>
          </div>
          <div class="col-12 col-md-4">
            <label for="poolSelect" class="form-label">Action Pool</label>
            <select id="poolSelect" class="form-select">
              <option value="">(loading…)</option>
            </select>
          </div>
          <div class="col-12 col-md-4 text-md-end">
            <button id="copyYamlBtn" class="btn btn-primary">Copy YAML</button>
          </div>
        </div>

        <pre class="bg-dark text-light rounded p-3 mb-0"><code id="yamlOutput" class="language-yaml">name: test
on:
  workflow_dispatch:
jobs:
  test:
    runs-on:
      group: prod
      labels:
        - action-group=prod
        - action-pool=one
    steps:
      - name: test
        run: echo "test"</code></pre>
      </div>
    </div>
  </section>

  <!-- Action Pools -->
  <section id="pools">
    <div class="d-flex align-items-center gap-2 mb-2">
      <h2 class="h5 mb-0">Action Pools</h2>
      <span id="poolCount" class="badge text-bg-secondary">0</span>
      <div class="ms-auto w-100 w-md-auto" style="max-width: 420px;">
        <input id="filterInput" class="form-control" placeholder="Filter by name, region, instance, OS, arch…" />
      </div>
    </div>

    <div id="poolGrid" class="row g-3"></div>

    <div id="emptyState" class="text-center text-muted py-5 d-none">
      <p class="mb-1">No pools match your filter.</p>
      <p class="small">Try a different search term.</p>
    </div>
  </section>
</main>

<!-- Toasts -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
  <div id="toast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">Copied to clipboard.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
  const endpoint = 'api/v1/admin/action-pool-status';

  const els = {
    computeTypeBadge: document.getElementById('computeTypeBadge'),
    groupBadge: document.getElementById('groupBadge'),
    lastUpdated: document.getElementById('lastUpdated'),
    loadingWrap: document.getElementById('loadingWrap'),
    alertBox: document.getElementById('alertBox'),
    poolGrid: document.getElementById('poolGrid'),
    emptyState: document.getElementById('emptyState'),
    poolCount: document.getElementById('poolCount'),
    filterInput: document.getElementById('filterInput'),
    poolSelect: document.getElementById('poolSelect'),
    groupValue: document.getElementById('groupValue'),
    yamlOutput: document.getElementById('yamlOutput'),
    copyYamlBtn: document.getElementById('copyYamlBtn'),
    refreshBtn: document.getElementById('refreshBtn'),
    toast: document.getElementById('toast'),
  };

  const toast = new bootstrap.Toast(els.toast);

  function fmtDate(d = new Date()) { return d.toLocaleString(); }

  function humanOs(os) {
    if (!os) return '—';
    const raw = String(os);
    const s = raw.replace(/_/g,'').toLowerCase();
    const uMatch = s.match(/^ubuntu(\d{2})(?:\.|)(\d{2})$/);
    if (uMatch) return `Ubuntu ${uMatch[1]}.${uMatch[2]}`;
    const dMatch = s.match(/^debian(\d+)/);
    if (dMatch) return `Debian ${dMatch[1]}`;
    return raw.replaceAll('_',' ');
  }

  function humanArch(arch) {
    if (!arch) return '—';
    const a = String(arch).toUpperCase();
    if (a === 'X64') return 'x64';
    if (a === 'ARM64') return 'arm64';
    return arch;
  }

  function createBadge(text, cls='secondary') {
    const span = document.createElement('span');
    span.className = `badge text-bg-${cls} me-1 mb-1 badge-cap`;
    span.textContent = text;
    return span;
  }

  function clear(el) { while (el.firstChild) el.removeChild(el.firstChild); }

  function makeCard(key, pool) {
    const col = document.createElement('div');
    col.className = 'col-12 col-md-6 col-lg-4';

    const card = document.createElement('div');
    card.className = 'card h-100 shadow-sm card-hover';

    const body = document.createElement('div');
    body.className = 'card-body d-flex flex-column';

    const header = document.createElement('div');
    header.className = 'd-flex align-items-center mb-2';

    const title = document.createElement('h3');
    title.className = 'h6 mb-0';
    title.textContent = pool.name || key;
    header.appendChild(title);

    if (pool.default) { header.appendChild(createBadge('default','success')); }

    const meta = document.createElement('div');
    meta.className = 'mt-2';
    meta.append(
        createBadge(pool.region, 'primary'),
        createBadge(pool.instanceType, 'dark'),
        createBadge(`max ${pool.maxInstanceCount}`, 'secondary'),
        createBadge(`${pool.idleScaleDownInMinutes}m idle scale-down`, 'info'),
        createBadge(humanArch(pool.architecture), 'secondary'),
        createBadge(humanOs(pool.os), 'secondary'),
    );

    const list = document.createElement('ul');
    list.className = 'list-group list-group-flush my-2';
    const items = [
      ['Subnet', pool.subnet],
      ['Security Group', pool.securityGroup],
      ['Disk', pool.diskSettings ? `${pool.diskSettings.type ?? 'gp3'} / ${pool.diskSettings.size} GiB` : '—'],
      ['Key Pair', pool.keyPairName || '—'],
    ];
    items.forEach(([k,v]) => {
      const li = document.createElement('li');
      li.className = 'list-group-item small';
      li.innerHTML = `<strong>${k}:</strong> <span class="text-monospace">${v ?? '—'}</span>`;
      list.appendChild(li);
    });

    const footer = document.createElement('div');
    footer.className = 'mt-auto d-flex flex-wrap gap-2 pt-2';
    const useBtn = document.createElement('button');
    useBtn.className = 'btn btn-sm btn-outline-primary';
    useBtn.textContent = 'Use in workflow';
    useBtn.addEventListener('click', () => {
      els.poolSelect.value = pool.name;
      updateYaml();
      window.location.hash = '#workflow';
    });

    footer.appendChild(useBtn);

    body.append(header, meta, list, footer);
    card.appendChild(body);
    col.appendChild(card);
    return col;
  }

  function populateSelect(pools) {
    clear(els.poolSelect);
    const names = Object.keys(pools).sort((a,b) => {
      const da = pools[a].default ? -1 : 0;
      const db = pools[b].default ? -1 : 0;
      return da - db || a.localeCompare(b);
    });
    names.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name + (pools[name].default ? ' (default)' : '');
      els.poolSelect.appendChild(opt);
    });
  }

  function updateYaml() {
    const group = (window.__lastData?.runnerGroup || 'prod');
    const pool = els.poolSelect.value || 'one';
    const yaml = `name: test\non:\n  workflow_dispatch:\njobs:\n  test:\n    runs-on:\n      group: ${group}\n      labels:\n        - action-group=${group}\n        - action-pool=${pool}\n    steps:\n      - name: test\n        run: echo \"test\"`;
    els.yamlOutput.textContent = yaml;
  }

  function render(data) {
    els.computeTypeBadge.textContent = `compute: ${data.computeType ?? '—'}`;
    els.groupBadge.textContent = `group: ${data.runnerGroup ?? '—'}`;
    if (els.groupValue) els.groupValue.textContent = data.runnerGroup ?? '—';
    els.lastUpdated.textContent = fmtDate();
    window.__lastData = data;

    const pools = data.actionPool || {};
    els.poolCount.textContent = Object.keys(pools).length;
    populateSelect(pools);
    updateYaml();

    const q = (els.filterInput.value || '').trim().toLowerCase();
    clear(els.poolGrid);
    let visible = 0;
    Object.entries(pools)
    .sort((a,b) => (b[1].default?1:0) - (a[1].default?1:0) || a[0].localeCompare(b[0]))
    .forEach(([key, pool]) => {
      const haystack = [pool.name, pool.region, pool.instanceType, pool.os, pool.architecture].join(' ').toLowerCase();
      if (!q || haystack.includes(q)) {
        els.poolGrid.appendChild(makeCard(key, pool));
        visible++;
      }
    });
    els.emptyState.classList.toggle('d-none', visible !== 0);
  }

  async function load() {
    try {
      els.loadingWrap.classList.remove('d-none');
      els.alertBox.innerHTML = '';
      const res = await fetch(endpoint, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      render(data);
    } catch (err) {
      console.error(err);
      els.alertBox.innerHTML = `<div class="alert alert-danger" role="alert">Failed to load status from <code>${endpoint}</code>: ${err.message}</div>`;
    } finally {
      els.loadingWrap.classList.add('d-none');
    }
  }

  // Events
  els.copyYamlBtn.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(els.yamlOutput.textContent); toast.show(); }
    catch (e) { alert('Copy failed: ' + e.message); }
  });
  els.poolSelect.addEventListener('change', updateYaml);
  els.filterInput.addEventListener('input', () => render(window.__lastData || { actionPool: {} }));
  els.refreshBtn.addEventListener('click', load);

  // Initial load
  document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
